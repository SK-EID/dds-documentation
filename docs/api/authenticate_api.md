# Authentication API

## MobileAuthenticate

Query for starting authentication session.

First, certificate validity of the user's authentication certificate is verified. In case the certificate is valid, an authentication message is 
passed to the user's mobile phone. Otherwise, error message is returned. The resulting response to the query contains information about the user, 
transaction ID and optionally user's certificate for authentication and certificate validity information.

#### Query

+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| Parameter             | Type              | R | Description                                                                                           |
+=======================+===================+===+=======================================================================================================+
| IDCode                | String            | + | Personal Identification Code of the user.It is recommended to use both input parameters               |
|                       |                   |   | IDCode and PhoneNo! In case of Lithuanian Mobile-ID both IDCode and PhoneNo are mandatory.            |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| CountryCode           | String(2)         | - | Country of origin. ISO 3166-type 2-character country codes are used (e.g. EE)                         |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| PhoneNo               | String            | + | User's phone number with country code in form +xxxxxxxxx (e.g. +3706234566)..                         |
|                       |                   |   | If both PhoneNo and IDCode parameters are given, correspondence between personal code and             |
|                       |                   |   | phone number is verified and in case of inconsistency SOAP error code 301 is returned. It is          |
|                       |                   |   | recommended to use both input parameters IDCode and PhoneNo! In case of Lithuanian Mobile-ID users    |
|                       |                   |   | IDCode and PhoneNo are BOTH mandatory. (see chapter 5.2). If the element "PhoneNo" has been set,      |
|                       |                   |   | the country attribute set in the prefix is used (independent on the value of the                      |
|                       |                   |   | element "CountryCode").                                                                               |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| Language              | String(3)         | + | Language for user dialog in mobile phone. 3-letters capitalized acronyms are used.                    | 
|                       |                   |   | Possible values: EST, ENG, RUS, LIT                                                                   |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| ServiceName           | String(20)        | + | Name of the service – previously agreed with Application Provider and DigiDocService operator.        |
|                       |                   |   | Maximum length – 20 chars.                                                                            |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| MessageToDisplay      | String(40 bytes)  | - | Text displayed in addition to ServiceName and before asking authentication PIN.                       | 
|                       |                   |   | Maximum length is 40 bytes. In case of Latin letters, this means also a 40 character long text,       |
|                       |                   |   | but Cyrillic characters may be encoded by two bytes and you will not be able to send more             |
|                       |                   |   | than 20 symbols.                                                                                      |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| SPChallenge           | String(20)        | - | 10-byte random challenge generated by the Application Provider witch would be part of the             |
|                       |                   |   | message for signing by user during authentication. In HEX form.                                       | 
|                       |                   |   |                                                                                                       |
|                       |                   |   | > **NB!** For security reasons it is                                                                  |
|                       |                   |   | > recommended to always fill this field with a different random value every time. When authentication |
|                       |                   |   | > succeeds, it is recommended to verify that the user signed a message that contains this challenge   |
|                       |                   |   | > value. (For more information about signature verification, see the description of the ``Signature`` | 
|                       |                   |   | > element for the ``GetMobileAuthenticateStatus`` operation.)                                         |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| MessagingMode         | String            | + | Mode to be used to respond to theMobileAuthenticate query. Options are:                               |
|                       |                   |   | * ``asynchClientServer`` – Appliaction Provider will make repeated G_etMobileAuthenticateStatus_      | 
|                       |                   |   |   queries.                                                                                            |
|                       |                   |   | * ``asynchServerServer`` – the response will be sent to the Application Provider by in                |
|                       |                   |   |   asynchronous mode (see: parameter AsyncConfiguration)                                               |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| AsyncConfiguration    | Integer           | - | This parameter is required when using "asynchServerServer" messaging mode and identifies              |
|                       |                   |   | configuration mode. This value has to be previously agreed. Currently, _Java Message Services_ (JMS)  |
|                       |                   |   | interface is supported.                                                                               |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| ReturnCertData        | Boolean           | - | If ``TRUE``, certificate of the user is returned. Certificate is useful if AP wants to save it        |
|                       |                   |   | and/or independently verify correctness of the signature and validation data.                         |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+
| ReturnRevocationData  | Boolean           | - | If ``TRUE``, OCSP response to the certificate validity query is returned.                             |
+-----------------------+-------------------+---+-------------------------------------------------------------------------------------------------------+

#### Response

| **Parameter** | **Type** | **Description** |
| --- | --- | --- |
| Sesscode | Integer | Session code for current session |
| Status | String | "OK" if no errors **NB!**"OK" does not mean that the user is successfully authenticated – response "USER\_AUTHENTICATED" would indicate this instead.In case error occurs, a SOAP error object is returned. Description of the SOAP error object and list of error codes are described in section 9.4. |
| UserIDCode | String | Personal Identity Code of the user. The value is fetched from "Serial Number" field of the certificate |
| UserGivenname | String | First name of the user. The value is fetched from "G" (given name) field of the certificate |
| UserSurname | String | Last name of the user. The value is fetched from "SN" (surname) field of the certificate |
| UserCountry | String(2) | Country of the origin in ISO 3166 2-character style. The value is fetched from "C" (country) field of the certificate |
| UserCN | String | „Common Name" of the certificate holder. The value is fetched from "CN" (common name) field of the certificate |
| CertificateData | String | User's certificate in BASE64 coding. Returned if parameter ReturnCertData was set „TRUE" in the query. |
| ChallengeID | String | 4-character control code calculated on basis of  the Challenge value to be signed. This code is displayed on mobile phone's screen and shall be also displayed by Application Provider in order to ensure the user on authenticity of the query. **NB!** Application provider must ask user to verify that those codes are the same. |
| Challenge | String | The data to be signed by the user. Consists of mixture of data sent by Application Provider in SPChallenge (10 bytes) field of the query and data added by DigiDocService (also 10 bytes).Returned only if SPChallenge field in the query was set. |
| RevocationData | String | OCSP response in BASE64 coding. Returned if parameter ReturnRevocationData was set „TRUE" in the query. |

In case asynchClientServer messaging mode is used, the Application Provider shall start sending GetMobileAuthenticateStatus queries until error message or positive answer will be returned.

> **NB!** It is reasonable to wait 15 seconds before starting sending status queries  - it is improbable that message from user's phone 
> arrives earlier because of technical and human limitations. Mobile-ID transactions will time out in 4 minutes or less.

When using asynchServerServer messaging mode, a message is sent to the Application Provider in accordance with previously agreed configuration.

The structure of the XML message sent back to Application provider is as follows:

| **Parameter** | **Type** | **Description** |
| --- | --- | --- |
| Sesscode | Integer | Session identifier |
| Status | String | "USER\_AUTHENTICATED" in case of successful authentication. Other possible values are described in the description of response to the "GetMobileAuthenticateStatus" query. |
| Data | String | Signature value in BASE64 encoding. Returned only if SPChallenge field in the query was set. For more info, see the "Signature" field in the chapter 7.2 and chapter 4.2 |


## GetMobileAuthenticateStatus

This method is relevant when asynchClientServer messaging mode is used.

#### Query

| **Parameter** | **Type** | **R** | **Description** |
| --- | --- | --- | --- |
| Sesscode | Integer | + | Session identifier – use the value returned with MobileAuthenticate method |
| WaitSignature | Boolean | + | "If "TRUE", then the Service will wait for a response from MSSP before responding. If "FALSE" then response is returned immediately and the application should invoke GetMobileAuthenticate again after a small delay (2-10 seconds). |

#### Response

+-----------------------+---------------+--------------------------------------------------------------------------------------------+
| Parameter             | Type          | Description                                                                                |
+=======================+===============+============================================================================================+
| Status                | String        | Process status:                                                                            |
|                       |               |                                                                                            |
|                       |               | * ``OUTSTANDING_TRANSACTION`` – authentication is still on the way;                        |
|                       |               | * ``USER_AUTHENTICATED`` – authentication successful;                                      |   
|                       |               | * ``NOT_VALID`` – the action is completed but the signature created is not valid;          |
|                       |               | * ``EXPIRED_TRANSACTION`` – timeout;                                                       |
|                       |               | * ``USER_CANCEL`` – user cancelled the action;                                             |
|                       |               | * ``MID_NOT_READY`` – the MobileID of the SIM is not yet ready for the operations;         |
|                       |               | * ``PHONE_ABSENT`` – phone is switched off or out of coverage;                             |
|                       |               | * ``SENDING_ERROR`` – other error when sending message (phone is incapable of receiving the|
|                       |               |   message, error in messaging server etc.);                                                |
|                       |               | * ``SIM_ERROR`` – SIM application error;                                                   |
|                       |               | * ``INTERNAL_ERROR`` – technical error.                                                    |
+-----------------------+---------------+--------------------------------------------------------------------------------------------+
| Signature             | String        | * Raw signature value in Base64 encoding. Returned only if SPChallenge field in            |
|                       |               |   the query was set in the MobileAuthenticate request.                                     |   
|                       |               | * NB! For security reasons it is recommended that application providers verify this        |
|                       |               |   signature. The signature signs the challenge value that was returned by the              |
|                       |               |   MobileAuthenticate call (the "Challenge" field). It should also be verified that the     |
|                       |               |   first 10 bytes of this challenge were chosen by the application provider (that is,       |
|                       |               |   they should be equal to the value "SPChallenge" that was passed into MobileAuthenticate).|
|                       |               | * Note that the authentication signatures are calculated without hash functions, both in   |
|                       |               |   the case of RSA and ECDSA. For example, if the challenge                                 |
|                       |               |   was "12345678901234567890369330D3483DAED0496D", (where the first half was chosen by      |
|                       |               |   the application provider), then the algorithm proceeds as if this challenge was          |
|                       |               |   actually a hash value. Therefore, for RSA, the usual SHA-1 prefix is prepended to the    |
|                       |               |   challenge before signing (even though the value did not come from SHA-1; this is         |
|                       |               |   the standard SHA-1 prefix from PKCS #1). As usual, ECDSA does not have prefixes.         |
|                       |               | * The signature should be verified against the authentication certificate of               |
|                       |               |   the given user (as returned by the "CertificateData" field in MobileAuthenticate).       |
+-----------------------+---------------+--------------------------------------------------------------------------------------------+

The session will be terminated unless the Status has value OUTSTANDING\_TRANSACTION.


## CheckCertificate

Given method can be used to check the validity of certificates (including ID-card and other smartcard certificates and also digital stamp certificates issued by AS Sertifitseerimiskeskus) and number of foreign Certification Authorities. Additional info is available from the sales department of Sertifitseerimiskeskus.

Additionally, this operation returns the values of the most important fields from the certificate.

#### Query

| **Parameter** | **Type** | **R** | **Description** |
| --- | --- | --- | --- |
| Certificate | String | + | Certificate to be checked for validity, in Base64 format. May include „---BEGIN CERTIFICATE---„ and „---END CERTIFICATE---„ lines (according to PEM format) |
| ReturnRevocationData | Boolean | - | If TRUE, certificate's validity information is returned on RevocationData field in response. |

#### Response

+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| Parameter             | Type              | Description                                                                                           |
+=======================+===================+=======================================================================================================+
| Sesscode              | Integer           | Identifier of the created session                                                                     |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| Status                | String            | Certificate's validity information:                                                                   | 
|                       |                   |                                                                                                       | 
|                       |                   | * ``GOOD`` – certificate is valid                                                                     |
|                       |                   | * ``REVOKED`` – certificate has been revoked                                                          |
|                       |                   | * ``UNKNOWN`` – certificate has never been issued or issuer is unknown                                |
|                       |                   | * ``EXPIRED`` – certificate has been expired                                                          |
|                       |                   | * ``SUSPENDED`` – certificate has been suspended                                                      |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| UserIDCode            | String            | Certificate owner's Personal Identification Code. In case certificate has been issued by SK,          |
|                       |                   | this value will be taken from certificate subject's serial number field.                              |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| UserGivenname         | String            | Certificate owner's given name, this value will be taken from certificate subject's G (given name)    | 
|                       |                   | field.                                                                                                |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| UserSurname           | String            | Certificate owner's surname, this value will be taken from certificate subject's S (surname) field.   |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| UserCountry           | String(2)         | Certificate owner's country, this value will be taken from certificate subject's C (country) field.   |
|                       |                   | ISO 3166 2-letter country codes are used.                                                             |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| UserOrganisation      | String            | Certificate owner's organization, this value will be taken from certificate                           | 
|                       |                   | subject's O (Organization) field.                                                                     |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| UserCN                | String            | Certificate owner's common name, this value will be taken from certificate subject's                  | 
|                       |                   | CN (Common name) field.                                                                               |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| Issuer                | String            | Certificate issuer's common name, this value will be taken from certificate issuers's                 | 
|                       |                   | CN (Common name) field.                                                                               |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| KeyUsage              | String            | Usage of the (secret) key related to the certificate.                                                 |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| EnhancedKeyUsage      | String            | Enhanced key usage                                                                                    |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+
| RevocationData        | String            | Certificate's validity information (OCSP service's response) in Base64 format. Returned only if       | 
|                       |                   | request parameter ReturnRevocationData has been set to TRUE, otherwise empty string is returned.      |
+-----------------------+-------------------+-------------------------------------------------------------------------------------------------------+

Response parameters are all UTF-8 encoded.





